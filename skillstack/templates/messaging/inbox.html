{% extends 'base.html' %}
{% block title %}Messages{% endblock %}

{% block content %}
<div class="container mt-5">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">
      Messages
      {% if unread_count > 0 %}
        <span class="badge bg-danger">{{ unread_count }}</span>
      {% endif %}
    </h2>
    <a href="{% url 'compose' %}" class="btn btn-dark">New Message</a>
  </div>

  <form method="get" class="mb-3 d-flex">
    <input type="text" name="q" class="form-control me-2" placeholder="Search messages..."
           value="{{ query|default:'' }}">
    <button type="submit" class="btn btn-outline-primary">Search</button>
  </form>

  {% if messages %}
    <div class="list-group">
      {% for msg in messages %}
        <a href="{% url 'message_detail' msg.pk %}" 
           class="list-group-item list-group-item-action 
           {% if not msg.is_read and msg.recipient == user %}fw-bold bg-light{% endif %}">
          <div class="d-flex justify-content-between">
            <h5 class="mb-1">{{ msg.subject }}</h5>
            <small>{{ msg.sent_at|date:"M d, Y H:i" }}</small>
          </div>
          <p class="mb-1 text-muted">
            {% if msg.sender == user %}
              To: {{ msg.recipient.username }} 
              <span class="badge bg-secondary">Sent</span>
            {% else %}
              From: {{ msg.sender.username }} 
              {% if not msg.is_read %}<span class="badge bg-success">Unread</span>{% endif %}
              <span class="badge bg-primary">Received</span>
            {% endif %}
          </p>
        </a>
      {% endfor %}
    </div>
  {% else %}
    <div class="alert alert-info text-center">No messages found.</div>
  {% endif %}
</div>
{% endblock %}