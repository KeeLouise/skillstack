{% extends 'base.html' %}
{% load static %}
{% block title %}{{ project.title }}{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/projects.css' %}">
{% endblock %}

{% block content %}
<div class="container py-5">
  <div class="project-detail card shadow-sm border-0 overflow-hidden">

    <div class="project-hero d-flex align-items-end p-4">
      <div class="w-100 d-flex flex-wrap align-items-center gap-3 gap-md-4">
        <div class="project-hero-mark"></div>
        <div class="flex-grow-1 text-white">
          <h2 class="mb-1 fw-bold">{{ project.title }}</h2>

          <div class="d-flex flex-wrap gap-2 mt-1">
            <span class="meta-chip">
              Category: <strong>{{ project.category|title }}</strong>
            </span>
            <span class="meta-chip">
              Owner: <strong>{{ project.owner.get_full_name|default:project.owner.username }}</strong>
            </span>
            <span class="meta-chip">
              Start: <strong>{{ project.start_date }}</strong>
            </span>
            <span class="meta-chip">
              End: <strong>{{ project.end_date }}</strong>
            </span>
          </div>
        </div>

        <div class="ms-auto d-flex flex-wrap gap-2">
          <a href="{% url 'dashboard' %}" class="btn btn-dark">Dashboard</a>
          {% if user == project.owner %}
            <a href="{% url 'edit_project' project.pk %}" class="btn btn-dark">Edit Project</a>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="card-body p-4 p-md-5">

      <div class="row g-4">
        <div class="col-lg-6">
         <div class="section-card">
    <div class="d-flex align-items-center justify-content-between mb-2">
  <h5 class="mb-0">Status</h5>
  <div id="project-status-badge-wrap">
    {% if project.status == 'completed' %}
      <span id="project-status-badge" class="badge project-status-badge bg-success">Completed</span>
    {% elif project.status == 'ongoing' %}
      <span id="project-status-badge" class="badge project-status-badge bg-warning text-dark">Ongoing</span>
    {% else %}
      <span id="project-status-badge" class="badge project-status-badge bg-danger">Paused</span>
    {% endif %}
  </div>
</div>
<hr class="my-3">

{% if user == project.owner %}
  <select
    id="statusDropdown"
    class="form-select form-select-sm w-auto"
    data-update-url="{% url 'update_project_status' project.pk %}"
    data-current="{{ project.status }}">
    <option value="">Select status</option>
    {% for value,label in status_choices %}
      <option value="{{ value }}" {% if project.status == value %}selected{% endif %}>{{ label }}</option>
    {% endfor %}
  </select>
  <span id="statusSaveMsg" class="small ms-2 text-muted"></span>
{% else %}
  {% if project.status == 'completed' %}
    <span class="badge bg-success">Completed</span>
  {% elif project.status == 'ongoing' %}
    <span class="badge bg-warning text-dark">Ongoing</span>
  {% else %}
    <span class="badge bg-danger">Paused</span>
  {% endif %}
{% endif %}

    <p class="text-muted small mb-2">Description</p>
    <div class="description-box">
      {{ project.description|linebreaks }}
    </div>
  </div>
</div>

        <div class="col-lg-6">
          <div class="section-card">
            <h5 class="mb-2">People</h5>
            <hr class="my-3">
            <div class="d-flex flex-wrap gap-2">
              <span class="badge text-bg-light border">Owner: {{ project.owner.get_full_name|default:project.owner.username }}</span>
              {% if project.collaborators.count %}
                {% for collaborator in project.collaborators.all %}
                  <span class="badge text-bg-light border">
                    {{ collaborator.get_full_name|default:collaborator.username }}
                  </span>
                {% endfor %}
              {% else %}
                <span class="text-muted small">No collaborators yet.</span>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      {% if can_upload %}
      <div class="section-card mt-4">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <h5 class="mb-0">Upload Attachments</h5>
        </div>
        <hr class="my-3">
        <form method="post"
              action="{% url 'upload_project_attachments' project.pk %}"
              enctype="multipart/form-data" class="d-flex flex-column gap-3">
          {% csrf_token %}
          <div class="upload-dropzone">
            {{ upload_form.files }}
          </div>
          <div class="d-flex align-items-center gap-3">
            <button type="submit" class="btn btn-dark">Upload</button>
            <small class="text-muted">You can select multiple files.</small>
          </div>
        </form>
      </div>
      {% endif %}

      {% if attachments %}
  <div class="section-card mt-4">
    <div class="d-flex align-items-center justify-content-between mb-2">
      <h5 class="mb-0">Attachments</h5>
    </div>
    <hr class="my-3">

    <ul class="attachment-list list-unstyled mb-0">
      {% for att in attachments %}
        <li class="attachment-item">
          <div class="d-flex align-items-center gap-3">
            <div class="file-pill" aria-hidden="true"></div>
            <div class="flex-grow-1">
              <a class="attachment-link" href="{% url 'download_project_attachment' att.pk %}">
                {{ att.original_name|default:att.file.name }}
              </a>
              {% if att.size %}
                <span class="text-muted small">({{ att.size|filesizeformat }})</span>
              {% endif %}
              <div class="small text-muted">
                Uploaded by:
                {% if att.uploaded_by %}
                  {{ att.uploaded_by.get_full_name|default:att.uploaded_by.username }}
                {% else %}
                  Unknown
                {% endif %}
              </div>
            </div>

            {% if user == project.owner or user == att.uploaded_by %}
              <form method="post" action="{% url 'delete_project_attachment' att.pk %}">
                {% csrf_token %}
                <button type="submit" class="btn btn-sm btn-outline-danger"
                        onclick="return confirm('Delete this attachment?');">
                  Delete
                </button>
              </form>
            {% endif %}
          </div>
        </li>
      {% endfor %}
    </ul>
  </div>
{% else %}
  <div class="section-card mt-4 text-center text-muted py-5">
    <div class="mb-2">No attachments yet.</div>
    {% if can_upload %}
      <small>Use the upload section above to add files.</small>
    {% endif %}
  </div>
{% endif %}
    </div>

    <div class="card-footer bg-transparent border-top-0 d-flex justify-content-between">
      <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary">‚Üê Back to Dashboard</a>

      {% if user == project.owner %}
      <div class="d-flex gap-2">
        <a href="{% url 'edit_project' project.pk %}" class="btn btn-warning">Edit</a>
        <form method="post" action="{% url 'delete_project' project.pk %}">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger"
                  onclick="return confirm('Are you sure you want to delete this project?');">
            Delete
          </button>
        </form>
      </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock content %}
{% block extra_scripts %}
<script src="{% static 'js/projects.js' %}"></script>
{% endblock %}