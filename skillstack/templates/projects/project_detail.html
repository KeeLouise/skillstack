{% extends 'base.html' %}
{% load static %}
{% block title %}{{ project.title }}{% endblock %}

{% block content %}
<div class="container py-5">
  <div class="card shadow-lg border-0">
    <div class="card-body">
      <h2 class="card-title text-primary fw-bold">{{ project.title }}</h2>
      <hr>
      <p><strong class="text-muted">Description:</strong><br> {{ project.description }}</p>

      <div class="row mt-4">
        <div class="col-md-6">
          <p><strong class="text-muted">Status:</strong>
            {% if project.status == 'completed' %}
              <span class="badge bg-success">Completed</span>
            {% elif project.status == 'ongoing' %}
              <span class="badge bg-warning text-dark">Ongoing</span>
            {% else %}
              <span class="badge bg-danger">Paused</span>
            {% endif %}
          </p>
          <p><strong class="text-muted">Start Date:</strong> {{ project.start_date }}</p>
          <p><strong class="text-muted">End Date:</strong> {{ project.end_date }}</p>
        </div>
        <div class="col-md-6">
          <p><strong class="text-muted">Category:</strong> {{ project.category }}</p>
          <p><strong class="text-muted">Owner:</strong> {{ project.owner.username }}</p>

          {% if project.collaborators.count %}
            <p>
              <strong class="text-muted">Collaborators:</strong>
              {% for user in project.collaborators.all %}
                <span class="badge bg-secondary">{{ user.get_full_name|default:user.username }}</span>{% if not forloop.last %} {% endif %}
              {% endfor %}
            </p>
          {% endif %}
        </div>
      </div>

      <hr class="mt-4">

      <div class="d-flex align-items-center justify-content-between mb-3">
        <h5 class="mb-0">Attachments</h5>

        {% if can_upload %}
      <form method="post"
      action="{% url 'upload_project_attachments' project.pk %}"
      enctype="multipart/form-data"
      class="d-flex gap-2 align-items-center">
  {% csrf_token %}
  {{ upload_form.files }}
       <button type="submit" class="btn btn-outline-primary btn-sm">Upload</button>
      </form>
{% endif %}
      </div>

      {% if attachments %}
        <ul class="list-group list-group-flush">
          {% for att in attachments %}
            <li class="list-group-item d-flex justify-content-between align-items-start">
              <div class="me-3">
                <a href="{% url 'download_project_attachment' att.pk %}" class="fw-semibold text-decoration-none">
                  {{ att.original_name|default:att.file.name }}
                </a>
                <div class="small text-muted">
                  {% if att.size %}{{ att.size|filesizeformat }} · {% endif %}
                  Uploaded by {{ att.uploaded_by.get_full_name|default:att.uploaded_by.username }} ·
                  {{ att.created_at|date:"M d, Y H:i" }}
                </div>
              </div>

              <div class="d-flex gap-2">
                <a href="{% url 'download_project_attachment' att.pk %}" class="btn btn-sm btn-outline-secondary">Download</a>
                {% if user == project.owner or user == att.uploaded_by %}
                  <form action="{% url 'delete_project_attachment' att.pk %}" method="post" onsubmit="return confirm('Delete this attachment?');">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                  </form>
                {% endif %}
              </div>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <div class="alert alert-light border d-flex align-items-center">No attachments yet.</div>
      {% endif %}
    </div>

    <div class="card-footer bg-transparent border-top-0 d-flex justify-content-between">
      <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary">← Back to Dashboard</a>

      {% if user == project.owner %}
        <div>
          <a href="{% url 'edit_project' project.pk %}" class="btn btn-warning me-2">Edit</a>
          <form method="POST" action="{% url 'delete_project' project.pk %}" style="display:inline;">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to delete this project?');">
              Delete
            </button>
          </form>
        </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}